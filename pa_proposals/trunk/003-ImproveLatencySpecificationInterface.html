<HTML>

<HEAD>
<TITLE>Proposed Changes to PortAudio</TITLE>
<META content="Phil Burk, Ross Bencina" name=Author>
<META content="Changes being discussed by the community of PortAudio deveopers." name=Description>
<META 
content="PortAudio, audio, tutorial, library, portable, open-source, DirectSound, sound, music, JSyn, AudioMulch, synthesis" name=KeyWords>
</HEAD>

<BODY LINK="#0000ff" VLINK="#800080">

<CENTER>
<H3>Proposed Enhancements to PortAudio API</H3>
<H1>003 - Improve Latency Specification Interface</H1>
</CENTER>

<P><A href="index.html">Enhancement Proposals Index</A>,
<A href="http://www.portaudio.com/">PortAudio Home Page</A></P>
<P>Updated: July 30, 2002 </P>

<H4>Status</H4>

<P>
This proposal is sufficiently well defined to be implemented. The current V19 implementation is not up to date (it uses frames instead of seconds for the suggestedInputLatency and suggestedOuputLatency parameters to Pa_OpenStream, and doesn't provide the default latency or latency querying functions.)
</P>

<H4>Background</H4>

<P>
The current mechanism for setting latency is not considered optimal by all clients of the API. There seems to be some tension between using the framesPerBuffer parameter of Pa_OpenStream as a latency control parameter and as a specifier for the number of frames supplied to the callback. Specifying latency as a single millisecond value would be more user friendly for some users, however some host APIs need latency to be tuned by specifying buffer sizes and number of buffers. Additionally, it has been suggested that separate input and output buffer counts would allow tuning of lower latencies in some circumstances.
</P>

<P>
A related issue is the need to improve the interface available to determine default latency parameters. The most recent proposal is documented below, however there is still some debate as to whether this is satisfactory. 
</P>

<P>
See this thread: <A HREF="http://techweb.rfa.org/pipermail/portaudio/2001-October/000196.html">http://techweb.rfa.org/pipermail/portaudio/2001-October/000196.html</A>
</P>


<H4>Proposal</H4>

<P>
The numBuffers parameter to Pa_OpenStream() will be removed, and replaced by two new parameters suggestedInputLatency and suggestedOutputLatency, both expressed in seconds. These parameters allow clients to fine-tune latency in a portable manner. Where practical PortAudio implementations should select buffer sizes based on these parameters, otherwise they may choose the closest viable buffer size and latency instead. In such cases the PortAudio implementations should round-up (ie always provide an equal or higher latency than requested.) 
</P>

<P>
The following functions will be supplied to retrieve default input and output latency values. Separate default latency values are provided for interactive applications where low latency is important to useful operation, and for robust applications where additional latency is acceptable if it will result in more stable performance or place a reduced load on the system.
</P>

<PRE> 
typedef double PaTime; /* time expressed in seconds */

PaTime Pa_GetDefaultLowInputLatency( PaDeviceIndex deviceID ); /* For interactive performance. */
PaTime Pa_GetDefaultHighInputLatency( PaDeviceIndex deviceID ); /* For playing sound files. */
PaTime Pa_GetDefaultLowOutputLatency( PaDeviceIndex deviceID ); /* For interactive performance. */
PaTime Pa_GetDefaultHighOutputLatency( PaDeviceIndex deviceID ); /* For playing sound files. */
</PRE>

<P>
Currently, when numBuffers is greater than 0, Pa_OpenStream will constrain the actual numBuffers so that the latency is within a valid range determined by the host API, or an environment variables such as PA_MIN_LATENCY_MSEC. Propose changing the behavior so that the requested value is honored as much as possible. This will allow the user to override the recommended minimum latency if they know their system can handle it. This might be used, for example on patched Linux kernels.
</P>

<P>
The following two functions are proposed to retrieve the input and output latency of a stream. Both return the latency in seconds.
</P>

<PRE>
/* the following would operate directly on streams */
PaTime Pa_GetStreamInputLatency( PaStream *stream );
PaTime Pa_GetStreamOutputLatency( PaStream *stream );
</PRE>

<P>
Where the host API does not provide this information directly, an estimate should be derived from the size and number of buffers used by the host API. For a multi-buffered system, the latency can be calculated as (oneBufferDuration * (numberOfBuffers-1)).
</P>

<P>
The Pa_GetMinNumBuffers( int framesPerBuffer, double sampleRate ) function will be removed, as it's functionality is fulfilled by the get recommended latency functions.
</P>

<P>
In addition to the portable latency setting mechanism described above, implementations may use the inputStreamInfo and outputStreamInfo Pa_OpenStream() parameters to provide host API specific latency setting mechanisms which directly reflect the underlying buffer passing scheme. For example, the MME streamInfo structure could provide a way to directly set the bufferSize and numberOfBuffers parameters for input and output. When streamInfo structures are passed to Pa_OpenStream(), using 0 values for their API specific latency settings PortAudio could use the 
generic latency parameters.
</P>

<P>
In cases where Host API specific latency parameters may be limited to certain allowable ranges (buffer sizes in ASIO for example) a method for querying these limits should be provided. This will consist of host-API specific query functions declared in a host-api specific header file. These header files will also contain the declaration of the host API specific driverInfo structure.
</P>

<H4>Discussion</H4>

<P>
This proposal provides both a high level mechanism for portable latency tuning, and suggests a method for providing a host-API specific latency tuning interface. Default latency query functions are provided to support simple portable applications.
</P>

<P>
Expressing suggestedLatency in frames was considered, but rejected because it makes sense to return the actual latency from Pa_GetStreamInputLatency() in seconds, and being consistent was deemed to be important for clarity and avoiding usage errors.
</P>

<H4>Impact Analysis</H4>

<P>
This proposal will require all clients to alter their calls to Pa_OpenStream(). Clients who passed a 0 value for numBuffers will not need to significantly alter their code. Clients who manipulated numBuffers will need to either use the latency parameters, or the host API specific interfaces, as they become available.
</P>

</BODY>
</HTML>
